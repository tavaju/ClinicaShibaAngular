<div class="container">
  <h1 class="shop-title">Tienda de Mascotas</h1>
  <div class="card">
    <!-- Loading indicator -->
    <div *ngIf="loading" class="loading-container">
      <p-progressSpinner styleClass="w-4rem h-4rem" strokeWidth="5" fill="var(--surface-ground)" animationDuration=".5s"></p-progressSpinner>
      <p>Cargando productos...</p>
    </div>

    <!-- Error message -->
    <div *ngIf="error" class="error-container">
      <p-message severity="error" [text]="error"></p-message>
      <button pButton label="Reintentar" icon="pi pi-refresh" (click)="loadProducts()" class="p-button-outlined mt-3"></button>
    </div>

    <div *ngIf="!loading && !error">
      <!-- Search and filters section -->
      <div class="p-grid">
        <div class="p-col-12">
          <div class="search-container">
            <div class="p-inputgroup">
              <span class="p-inputgroup-addon">
                <i class="pi pi-search"></i>
              </span>
              <input 
                type="text" 
                pInputText 
                placeholder="Buscar productos..." 
                [(ngModel)]="searchQuery" 
                (input)="onSearch($event)"
              />
              <button 
                *ngIf="searchQuery" 
                pButton 
                icon="pi pi-times" 
                class="p-button-danger" 
                (click)="clearSearch()">
              </button>
            </div>
          </div>
        </div>
        
        <!-- Filter options -->
        <div class="p-col-12">
          <div class="filters-container p-d-flex p-jc-between p-ai-center p-flex-wrap">
            <div class="p-field p-mr-3 p-mb-2">
              <p-dropdown [options]="categories" 
                          placeholder="Filtrar por categoría" 
                          (onChange)="onCategoryChange($event)" 
                          [(ngModel)]="selectedCategory"
                          [showClear]="true"
                          styleClass="filter-dropdown"></p-dropdown>
            </div>
            <div class="p-field p-mr-3 p-mb-2">
              <p-dropdown [options]="statusOptions" 
                          placeholder="Filtrar por disponibilidad" 
                          (onChange)="onStatusChange($event)" 
                          [(ngModel)]="selectedStatus"
                          [showClear]="true"
                          styleClass="filter-dropdown"></p-dropdown>
            </div>
            <button *ngIf="selectedCategory || selectedStatus" 
                    pButton 
                    label="Limpiar filtros" 
                    icon="pi pi-filter-slash" 
                    class="p-button-outlined p-mb-2" 
                    (click)="clearFilters()"></button>
          </div>
        </div>
      </div>

      <p-dataView #dv [value]="filteredProducts" [layout]="layout" [paginator]="true" [rows]="9" 
                  [sortField]="sortField" [sortOrder]="sortOrder">
        <ng-template pTemplate="header">
          <div class="flex flex-column md:flex-row md:justify-content-between">
            <div class="flex justify-content-end">
              <p-dropdown [options]="sortOptions" placeholder="Ordenar por" 
                          (onChange)="onSortChange($event)" styleClass="mb-2 md:mb-0"></p-dropdown>
              <p-button icon="pi pi-th-large" 
                        (onClick)="layout = 'grid'" 
                        styleClass="ml-2" 
                        [outlined]="layout !== 'grid'"></p-button>
              <p-button icon="pi pi-bars" 
                        (onClick)="layout = 'list'" 
                        styleClass="ml-2" 
                        [outlined]="layout !== 'list'"></p-button>
            </div>
          </div>
        </ng-template>
        
        <ng-template let-product pTemplate="listItem">
          <div class="product-list-item">
            <div class="product-list-image">
              <img [src]="product.image" [alt]="product.name" />
            </div>
            <div class="product-list-detail">
              <div class="product-name">{{product.name}}</div>
              <div class="product-description">{{product.description}}</div>
              <p-rating [ngModel]="product.rating" [readonly]="true" [cancel]="false"></p-rating>
              <div class="product-category">
                <i class="pi pi-tag product-category-icon"></i>
                <span>{{product.category}}</span>
              </div>
            </div>
            <div class="product-list-action">
              <span class="product-price">${{formatPrice(product.price)}}</span>
              <p-tag [value]="getInventoryStatus(product.inventoryStatus)" [severity]="getSeverity(product.inventoryStatus)"></p-tag>
              <button pButton icon="pi pi-shopping-cart" label="Añadir al carrito" class="list-view-cart-button" [disabled]="product.inventoryStatus === 'OUTOFSTOCK'"></button>
            </div>
          </div>
        </ng-template>
        
        <ng-template let-product pTemplate="gridItem">
          <div class="col-12 sm:col-6 lg:col-4 xl:col-3 p-2 grid-item">
            <div class="p-4 border-1 surface-border surface-card border-round h-full product-card">
              <div class="flex flex-wrap align-items-center justify-content-between gap-2">
                <div class="flex align-items-center gap-2">
                  <i class="pi pi-tag"></i>
                  <span class="font-semibold">{{ product.category }}</span>
                </div>
                <p-tag [value]="getInventoryStatus(product.inventoryStatus)" [severity]="getSeverity(product.inventoryStatus)"></p-tag>
              </div>
              <div class="flex flex-column align-items-center gap-3 py-5">
                <img class="product-image shadow-2 border-round" [src]="product.image" [alt]="product.name" />
                <div class="text-2xl font-bold">{{ product.name }}</div>
                <p-rating [ngModel]="product.rating" [readonly]="true" [cancel]="false"></p-rating>
              </div>
              <div class="flex align-items-center justify-content-between">
                <span class="text-2xl font-semibold">${{ formatPrice(product.price) }}</span>
                <button pButton icon="pi pi-shopping-cart" 
                        [disabled]="product.inventoryStatus === 'OUTOFSTOCK'"></button>
              </div>
            </div>
          </div>
        </ng-template>
        
        <ng-template pTemplate="empty">
          <div class="p-4 text-center">
            <div *ngIf="searchQuery || selectedCategory || selectedStatus; else noProducts">
              <p>No se encontraron productos con los criterios de búsqueda actuales.</p>
              <div class="p-d-flex p-jc-center p-mt-3">
                <button *ngIf="searchQuery" pButton label="Limpiar búsqueda" (click)="clearSearch()" class="p-button-outlined p-mr-2"></button>
                <button *ngIf="selectedCategory || selectedStatus" pButton label="Limpiar filtros" (click)="clearFilters()" class="p-button-outlined"></button>
              </div>
            </div>
            <ng-template #noProducts>
              <p>No hay productos disponibles.</p>
            </ng-template>
          </div>
        </ng-template>
      </p-dataView>
    </div>
  </div>
</div>
